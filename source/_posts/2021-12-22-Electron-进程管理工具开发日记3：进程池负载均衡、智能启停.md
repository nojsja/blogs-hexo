---
title: "Electron è¿›ç¨‹ç®¡ç†å·¥å…·å¼€å‘æ—¥è®°3ï¼šè¿›ç¨‹æ± è´Ÿè½½å‡è¡¡ã€æ™ºèƒ½å¯åœ"
subtitle: "Electron process management tool dev diary3: process pool load balancing, smart sleep and wake up"
catalog: true
comments: true
indexing: true
header-img: >-
  https://nojsja.gitee.io/static-resources/images/hexo/article_header/article_header.jpg
top: 1
tocnum: true
tags:
  - electron
  - node
  - process
categories:
  - Electron
  - Node
abbrlink: 1deae768
date: 2021-12-22 13:22:31
---


> æ–‡ä¸­å®ç°çš„éƒ¨åˆ†å·¥å…·æ–¹æ³•æ­£å¤„äºæ—©æœŸ/æµ‹è¯•é˜¶æ®µï¼Œä»åœ¨æŒç»­ä¼˜åŒ–ä¸­ï¼Œä»…ä¾›å‚è€ƒ...

> åœ¨ Ubuntu20.04 ä¸Šè¿›è¡Œå¼€å‘/æµ‹è¯•ï¼Œå¯ç”¨äº Electron é¡¹ç›®ï¼Œæµ‹è¯•ç‰ˆæœ¬ï¼šElectron@8.2.0 / 9.3.5

### Contents

------------

```sh
â”œâ”€â”€ Contents (you are here!)
â”‚
â”œâ”€â”€ I. å‰è¨€
â”œâ”€â”€ II. æ¶æ„å›¾
â”‚
â”œâ”€â”€ III.electron-re å¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Ÿ
â”‚Â Â  â”œâ”€â”€ 1) ç”¨äº Electron åº”ç”¨
â”‚   â””â”€â”€ 2) ç”¨äº Electron/Nodejs åº”ç”¨
â”‚
â”œâ”€â”€ IV. UI åŠŸèƒ½ä»‹ç»
â”‚Â Â  â”œâ”€â”€ ä¸»ç•Œé¢
â”‚Â Â  â”œâ”€â”€ åŠŸèƒ½1ï¼šKill è¿›ç¨‹
â”‚Â Â  â”œâ”€â”€ åŠŸèƒ½2ï¼šä¸€é”®å¼€å¯ DevTools
â”‚Â Â  â”œâ”€â”€ åŠŸèƒ½3ï¼šæŸ¥çœ‹è¿›ç¨‹æ—¥å¿—
â”‚Â Â  â”œâ”€â”€ åŠŸèƒ½4ï¼šæŸ¥çœ‹è¿›ç¨‹ CPU/Memory å ç”¨è¶‹åŠ¿
â”‚Â Â  â””â”€â”€ åŠŸèƒ½5ï¼šæŸ¥çœ‹ MessageChannel è¯·æ±‚å‘é€æ—¥å¿—
â”‚
â”œâ”€â”€ V. æ–°ç‰¹æ€§ï¼šè¿›ç¨‹æ± è´Ÿè½½å‡è¡¡
â”‚Â Â  â”œâ”€â”€ å…³äºè´Ÿè½½å‡è¡¡
â”‚Â Â  â”œâ”€â”€ è´Ÿè½½å‡è¡¡ç­–ç•¥è¯´æ˜
â”‚Â Â  â”œâ”€â”€ è´Ÿè½½å‡è¡¡ç­–ç•¥çš„ç®€æ˜“å®ç°
â”‚Â Â  â”œâ”€â”€ è´Ÿè½½å‡è¡¡å™¨çš„å®ç°
â”‚Â Â  â””â”€â”€ è¿›ç¨‹æ± é…åˆ LoadBalancer æ¥å®ç°è´Ÿè½½å‡è¡¡
â”‚
â”œâ”€â”€ VI. æ–°ç‰¹æ€§ï¼šå­è¿›ç¨‹æ™ºèƒ½å¯åœ
â”‚Â Â  â”œâ”€â”€ ä½¿è¿›ç¨‹ä¼‘çœ çš„å„ç§æ–¹å¼
â”‚Â Â  â”œâ”€â”€ ç”Ÿå‘½å‘¨æœŸ LifeCycle çš„å®ç°
â”‚Â Â  â””â”€â”€ è¿›ç¨‹äº’æ–¥é”çš„é›å½¢
â”‚
â”œâ”€â”€ VII. å­˜åœ¨çš„å·²çŸ¥é—®é¢˜
â”œâ”€â”€ VIII. Next To Do
â”‚
â”œâ”€â”€ IX. å‡ ä¸ªå®é™…ä½¿ç”¨ç¤ºä¾‹
â”‚Â Â  â”œâ”€â”€ 1) Service/MessageChannel ä½¿ç”¨ç¤ºä¾‹
â”‚Â Â  â”œâ”€â”€ 2) ä¸€ä¸ªå®é™…ç”¨äºç”Ÿäº§é¡¹ç›®çš„ä¾‹å­
â”‚Â Â  â”œâ”€â”€ 3) ChildProcessPool/ProcessHost ä½¿ç”¨ç¤ºä¾‹
â”‚Â Â  â”œâ”€â”€ 3) test æµ‹è¯•ç›®å½•ç¤ºä¾‹
â”‚Â Â  â””â”€â”€ 4) github README è¯´æ˜
â”‚
```

### I. å‰è¨€

---------------

ä¹‹å‰åœ¨åš Electron åº”ç”¨å¼€å‘çš„æ—¶å€™ï¼Œå†™äº†ä¸ª Electron è¿›ç¨‹ç®¡ç†å·¥å…· [electron-re](https://github.com/nojsja/electron-re)ï¼Œæ”¯æŒ Electron/Node å¤šè¿›ç¨‹ç®¡ç†ã€service æ¨¡æ‹Ÿã€è¿›ç¨‹å®æ—¶ç›‘æ§(UIåŠŸèƒ½)ã€Node.js è¿›ç¨‹æ± ç­‰ç‰¹æ€§ã€‚å·²ç»å‘å¸ƒä¸ºnpmç»„ä»¶ï¼Œå¯ä»¥ç›´æ¥å®‰è£…ï¼š

[>> githubåœ°å€](https://github.com/nojsja/electron-re)

```sh
$: npm install electron-re --save
# or
$: yarn add electron-re
```

æœ¬ä¸»é¢˜å‰é¢ä¸¤ç¯‡æ–‡ç« ï¼š

1. [ã€ŠElectron/Nodeå¤šè¿›ç¨‹å·¥å…·å¼€å‘æ—¥è®°ã€‹](https://nojsja.gitee.io/blogs/2020/12/08/6d582478.html/) æè¿°äº†`electron-re`çš„å¼€å‘èƒŒæ™¯ã€é’ˆå¯¹çš„é—®é¢˜åœºæ™¯ä»¥åŠè¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•ã€‚
2. [ã€ŠElectronå¤šè¿›ç¨‹å·¥å…·å¼€å‘æ—¥è®°2ã€‹](https://nojsja.gitee.io/blogs/2020/12/18/927d467e.html/) ä»‹ç»äº†æ–°ç‰¹æ€§ "å¤šè¿›ç¨‹ç®¡ç† UI" çš„å¼€å‘å’Œä½¿ç”¨ç›¸å…³ã€‚UI ç•Œé¢åŸºäº `electron-re` å·²æœ‰çš„ `BrowserService/MessageChannel` å’Œ `ChildProcessPool/ProcessHost` åŸºç¡€æ¶æ„é©±åŠ¨ï¼Œä½¿ç”¨ React17 / Babel7 å¼€å‘ã€‚

è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æè¿°æœ€è¿‘æ”¯æŒçš„è¿›ç¨‹æ± æ¨¡å—æ–°ç‰¹æ€§ - "è¿›ç¨‹æ± è´Ÿè½½å‡è¡¡" å’Œ "å­è¿›ç¨‹æ™ºèƒ½å¯åœ"ï¼Œä»¥åŠç›¸å…³çš„åŸºæœ¬å®ç°åŸç†ã€‚åŒæ—¶æå‡ºè‡ªå·±é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œä»¥åŠå¯¹è¿™äº›é—®é¢˜çš„æ€è€ƒã€è§£å†³æ–¹æ¡ˆï¼Œå¯¹ä¹‹åç‰ˆæœ¬è¿­ä»£çš„ä¸€äº›æƒ³æ³•ç­‰ç­‰ã€‚

### II. electron-reæ¶æ„å›¾

--------------

![archtecture](http://nojsja.gitee.io/static-resources/images/electron-re/electron-re.png)

- __Electron Core__ï¼šElectron åº”ç”¨çš„ä¸€ç³»åˆ—æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…å«äº†åº”ç”¨çš„ä¸»è¿›ç¨‹ã€æ¸²æŸ“è¿›ç¨‹ã€çª—å£ç­‰ç­‰(Electron è‡ªå¸¦)ã€‚
- __BrowserWindow__ï¼šæ¸²æŸ“çª—å£è¿›ç¨‹ï¼Œä¸€èˆ¬ç”¨äºUIæ¸²æŸ“ (Electron è‡ªå¸¦)ã€‚
- __ProcessManager__ï¼šè¿›ç¨‹ç®¡ç†å™¨ï¼Œè´Ÿè´£è¿›ç¨‹å ç”¨èµ„æºé‡‡é›†ã€å¼‚æ­¥åˆ·æ–°UIã€å“åº”å’Œå‘å‡ºå„ç§è¿›ç¨‹ç®¡ç†ä¿¡å·ï¼Œä½œä¸ºä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡ç»™å…¶å®ƒæ¨¡å—å’ŒUIæä¾›æœåŠ¡ (electron-re å¼•å…¥)ã€‚
- __MessageChannel__ï¼šé€‚ç”¨äºä¸»è¿›ç¨‹ã€æ¸²æŸ“è¿›ç¨‹ã€Service è¿›ç¨‹çš„æ¶ˆæ¯å‘é€å·¥å…·ï¼ŒåŸºäºåŸç”Ÿ IPC å°è£…ï¼Œä¸»è¦æœåŠ¡äº BrowserServiceï¼Œä¹Ÿå¯æ›¿ä»£åŸç”Ÿçš„ IPC é€šä¿¡æ–¹æ³• (electron-re å¼•å…¥)ã€‚
- __ChildProcess__ï¼šç”± `child_process.fork` æ–¹æ³•ç”Ÿæˆçš„å­è¿›ç¨‹ï¼Œä¸è¿‡ä»¥è£…é¥°å™¨çš„æ–¹å¼ä¸ºå…¶æ·»åŠ äº†ç®€å•çš„è¿›ç¨‹ä¼‘çœ å’Œå”¤é†’é€»è¾‘ (electron-re å¼•å…¥)ã€‚
- __ProcessHost__ï¼šé…åˆè¿›ç¨‹æ± ä½¿ç”¨çš„å·¥å…·ï¼Œæˆ‘ç§°å®ƒä¸º "è¿›ç¨‹äº‹åŠ¡ä¸­å¿ƒ"ï¼Œå°è£…äº† `process.send / process.on` åŸºæœ¬é€»è¾‘ï¼Œæä¾›äº† Promise çš„è°ƒç”¨æ–¹å¼è®© ä¸»è¿›ç¨‹/å­è¿›ç¨‹ ä¹‹é—´ IPC æ¶ˆæ¯é€šä¿¡æ›´ç®€å• (electron-re å¼•å…¥)ã€‚
- __ChildProcessPool__ï¼šåŸºäº Node.js - `child_process.fork` æ–¹æ³•å®ç°çš„è¿›ç¨‹æ± ï¼Œå†…éƒ¨ç®¡ç†å¤šä¸ª ChildProcess å®ä¾‹å¯¹è±¡ï¼Œæ”¯æŒè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ã€å­è¿›ç¨‹æ™ºèƒ½å¯åœã€å­è¿›ç¨‹å¼‚å¸¸é€€å‡ºåè‡ªåŠ¨é‡å¯ç­‰ç‰¹æ€§ (electron-re å¼•å…¥)ã€‚
- __BrowserService__ï¼šåŸºäº BrowserWindow å®ç°çš„ Service è¿›ç¨‹ï¼Œå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨åå°çš„éšè—æ¸²æŸ“çª—å£è¿›ç¨‹ï¼Œå…è®¸ Node æ³¨å…¥ï¼Œä¸è¿‡ä»…æ”¯æŒ `CommonJs` è§„èŒƒã€‚

### III. electron-re å¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Ÿ

--------------

#### 1. ç”¨äºElectronåº”ç”¨

- `BrowserService`
- `MessageChannel`

åœ¨ Electron çš„ä¸€äº›â€œæœ€ä½³å®è·µâ€ä¸­ï¼Œå»ºè®®å°†å ç”¨cpuçš„ä»£ç æ”¾åˆ°æ¸²æŸ“è¿‡ç¨‹ä¸­è€Œä¸æ˜¯ç›´æ¥æ”¾åœ¨ä¸»è¿‡ç¨‹ä¸­ï¼Œè¿™é‡Œå…ˆçœ‹ä¸‹ chromium çš„æ¶æ„å›¾ï¼š

![archtecture](http://nojsja.gitee.io/static-resources/images/electron-re/chromium.jpg)

æ¯ä¸ªæ¸²æŸ“è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå…¨å±€å¯¹è±¡ RenderProcessï¼Œç”¨æ¥ç®¡ç†ä¸çˆ¶æµè§ˆå™¨è¿›ç¨‹çš„é€šä¿¡ï¼ŒåŒæ—¶ç»´æŠ¤ç€ä¸€ä»½å…¨å±€çŠ¶æ€ã€‚æµè§ˆå™¨è¿›ç¨‹ä¸ºæ¯ä¸ªæ¸²æŸ“è¿›ç¨‹ç»´æŠ¤ä¸€ä¸ª RenderProcessHost å¯¹è±¡ï¼Œç”¨æ¥ç®¡ç†æµè§ˆå™¨çŠ¶æ€å’Œä¸æ¸²æŸ“è¿›ç¨‹çš„é€šä¿¡ã€‚æµè§ˆå™¨è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹ä½¿ç”¨ Chromium çš„ IPC ç³»ç»Ÿè¿›è¡Œé€šä¿¡ã€‚åœ¨ chromium ä¸­ï¼Œé¡µé¢æ¸²æŸ“æ—¶ï¼ŒUIè¿›ç¨‹éœ€è¦å’Œ main process ä¸æ–­çš„è¿›è¡Œ IPC åŒæ­¥ï¼Œè‹¥æ­¤æ—¶ main process å¿™ï¼Œåˆ™ UIprocess å°±ä¼šåœ¨ IPC æ—¶é˜»å¡ã€‚æ‰€ä»¥å¦‚æœä¸»è¿›ç¨‹æŒç»­è¿›è¡Œæ¶ˆè€— CPU æ—¶é—´çš„ä»»åŠ¡æˆ–é˜»å¡åŒæ­¥ IO çš„ä»»åŠ¡çš„è¯ï¼Œå°±ä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šé˜»å¡ï¼Œä»è€Œå½±å“ä¸»è¿›ç¨‹å’Œå„ä¸ªæ¸²æŸ“è¿›ç¨‹ä¹‹é—´çš„ IPC é€šä¿¡ï¼ŒIPC é€šä¿¡æœ‰å»¶è¿Ÿæˆ–æ˜¯å—é˜»ï¼Œæ¸²æŸ“è¿›ç¨‹çª—å£å°±ä¼šå¡é¡¿æ‰å¸§ï¼Œä¸¥é‡çš„è¯ç”šè‡³ä¼šå¡ä½ä¸åŠ¨ã€‚

å› æ­¤ `electron-re` åœ¨ Electron å·²æœ‰çš„ `Main Process` ä¸»è¿›ç¨‹ å’Œ `Renderer Process` æ¸²æŸ“è¿›ç¨‹é€»è¾‘çš„åŸºç¡€ä¸Šç‹¬ç«‹å‡ºä¸€ä¸ªå•ç‹¬çš„ `Service` æ¦‚å¿µã€‚`Service`å³ä¸éœ€è¦æ˜¾ç¤ºç•Œé¢çš„åå°è¿›ç¨‹ï¼Œå®ƒä¸å‚ä¸ UI äº¤äº’ï¼Œå•ç‹¬ä¸ºä¸»è¿›ç¨‹æˆ–å…¶å®ƒæ¸²æŸ“è¿›ç¨‹æä¾›æœåŠ¡ï¼Œå®ƒçš„åº•å±‚å®ç°ä¸ºä¸€ä¸ªå…è®¸ `nodeæ³¨å…¥` å’Œ `remoteè°ƒç”¨` çš„ __éšè—æ¸²æŸ“çª—å£è¿›ç¨‹__ã€‚

è¿™æ ·å°±å¯ä»¥å°†ä»£ç ä¸­è€—è´¹ cpu çš„æ“ä½œ(æ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ä¸­ç»´æŠ¤ä¸€ä¸ªæ•°åƒä¸ªä¸Šä¼ ä»»åŠ¡çš„é˜Ÿåˆ—)ç¼–å†™æˆä¸€ä¸ªå•ç‹¬çš„jsæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ `BrowserService` æ„é€ å‡½æ•°ä»¥è¿™ä¸ª js æ–‡ä»¶çš„åœ°å€ `path` ä¸ºå‚æ•°æ„é€ ä¸€ä¸ª `Service` å®ä¾‹ï¼Œä»è€Œå°†ä»–ä»¬ä»ä¸»è¿›ç¨‹ä¸­åˆ†ç¦»ã€‚å¦‚æœä½ è¯´é‚£è¿™éƒ¨åˆ†è€—è´¹ cpu çš„æ“ä½œç›´æ¥æ”¾åˆ°æ¸²æŸ“çª—å£è¿›ç¨‹å¯ä»¥å˜›ï¼Ÿè¿™å…¶å®å–å†³äºé¡¹ç›®è‡ªèº«çš„æ¶æ„è®¾è®¡ï¼Œä»¥åŠå¯¹è¿›ç¨‹ä¹‹é—´æ•°æ®ä¼ è¾“æ€§èƒ½æŸè€—å’Œä¼ è¾“æ—¶é—´ç­‰å„æ–¹é¢çš„æƒè¡¡ï¼Œåˆ›å»ºä¸€ä¸ª `Service` çš„ç®€å•ç¤ºä¾‹ï¼š

```js
const { BrowserService } = require('electron-re');
const myServcie = new BrowserService('app', path.join(__dirname, 'path/to/app.service.js'));
```

å¦‚æœä½¿ç”¨äº† `BrowserService` çš„è¯ï¼Œè¦æƒ³åœ¨ä¸»è¿›ç¨‹ã€æ¸²æŸ“è¿›ç¨‹ã€service è¿›ç¨‹ä¹‹é—´ç›¸äº’å‘é€æ¶ˆæ¯å°±è¦ä½¿ç”¨ `electron-re` æä¾›çš„ `MessageChannel` é€šä¿¡å·¥å…·ï¼Œå®ƒçš„æ¥å£è®¾è®¡è·Ÿ Electron å†…å»ºçš„`IPC`åŸºæœ¬ä¸€è‡´ï¼Œåº•å±‚ä¹Ÿæ˜¯åŸºäºåŸç”Ÿçš„ `IPC` å¼‚æ­¥é€šä¿¡åŸç†æ¥å®ç°çš„ï¼Œç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
/* ---- main.js ---- */
const { BrowserService } = require('electron-re');
// ä¸»è¿›ç¨‹ä¸­å‘ä¸€ä¸ª service 'app' å‘é€æ¶ˆæ¯
MessageChannel.send('app', 'channel1', { value: 'test1' });
```

#### 2. ç”¨äº Electron/Nodejs åº”ç”¨

- `ChildProcessPool`
- `ProcessHost`

æ­¤å¤–ï¼Œå¦‚æœè¦åˆ›å»ºä¸€äº›ä¸ä¾èµ–äº Electron è¿è¡Œæ—¶çš„å­è¿›ç¨‹ï¼ˆç›¸å…³å‚è€ƒnodejs `child_process`ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `electron-re` æä¾›çš„ä¸“é—¨ä¸º nodejs è¿è¡Œæ—¶ç¼–å†™çš„è¿›ç¨‹æ±  `ChildProcessPool` ã€‚å› ä¸ºåˆ›å»ºè¿›ç¨‹æœ¬èº«æ‰€éœ€çš„å¼€é”€å¾ˆå¤§ï¼Œä½¿ç”¨è¿›ç¨‹æ± æ¥é‡å¤åˆ©ç”¨å·²ç»åˆ›å»ºäº†çš„å­è¿›ç¨‹ï¼Œå°†å¤šè¿›ç¨‹æ¶æ„å¸¦æ¥çš„æ€§èƒ½æ•ˆç›Šæœ€å¤§åŒ–ï¼Œç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
/* --- ä¸»è¿›ç¨‹ä¸­ --- */
const { ChildProcessPool, LoadBalancer } = require('electron-re');

const pool = new ChildProcessPool({
  path: path.join(app.getAppPath(), 'app/services/child.js'), // å­è¿›ç¨‹æ‰§è¡Œæ–‡ä»¶è·¯å¾„
  max: 3, // æœ€å¤§è¿›ç¨‹æ•°
  strategy: LoadBalancer.ALGORITHM.WEIGHTS, // è´Ÿè½½å‡è¡¡ç­–ç•¥ - æƒé‡
  weights: [1, 2, 3], // æƒé‡åˆ†é…
});

pool
  .send('sync-work', params)
  .then(rsp => console.log(rsp));
```

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨æˆ‘ä»¬çš„å­è¿›ç¨‹æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä¸ºäº†åœ¨ä¸»è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´åŒæ­¥æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ `process.send('channel', params)` å’Œ `process.on('channel', function)` çš„æ–¹å¼å®ç°(å‰ææ˜¯è¿›ç¨‹ä»¥ä»¥ `fork` æ–¹å¼åˆ›å»ºæˆ–è€…æ‰‹åŠ¨å¼€å¯äº† `IPC` é€šä¿¡)ã€‚ä½†æ˜¯è¿™æ ·åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘çš„åŒæ—¶ä¹Ÿå¼ºè¿«æˆ‘ä»¬å»å…³æ³¨è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä½ éœ€è¦çŸ¥é“å­è¿›ç¨‹ä»€ä¹ˆæ—¶å€™èƒ½å¤„ç†å®Œæ¯•ï¼Œç„¶åå†ä½¿ç”¨`process.send`å†å°†æ•°æ®è¿”å›ä¸»è¿›ç¨‹ï¼Œä½¿ç”¨æ–¹å¼ç¹çã€‚

`electron-re` å¼•å…¥äº† `ProcessHost` çš„æ¦‚å¿µï¼Œæˆ‘ç§°ä¹‹ä¸º"è¿›ç¨‹äº‹åŠ¡ä¸­å¿ƒ"ã€‚å®é™…ä½¿ç”¨æ—¶åœ¨å­è¿›ç¨‹æ‰§è¡Œæ–‡ä»¶ä¸­åªéœ€è¦å°†å„ä¸ªä»»åŠ¡å‡½æ•°é€šè¿‡ `ProcessHost.registry('task-name', function)` æ³¨å†Œæˆå¤šä¸ªè¢«ç›‘å¬çš„äº‹åŠ¡ï¼Œç„¶åé…åˆè¿›ç¨‹æ± çš„ `ChildProcessPool.send('task-name', params)` æ¥è§¦å‘å­è¿›ç¨‹äº‹åŠ¡é€»è¾‘çš„è°ƒç”¨å³å¯ï¼Œ`ChildProcessPool.send()` åŒæ—¶ä¼šè¿”å›ä¸€ä¸ª Promise å®ä¾‹ä»¥ä¾¿è·å–å›è°ƒæ•°æ®ï¼Œç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
/* --- å­è¿›ç¨‹ä¸­ --- */
const { ProcessHost } = require('electron-re');

ProcessHost
  .registry('sync-work', (params) => {
    return { value: 'task-value' };
  })
  .registry('async-work', (params) => {
    return fetch(params.url);
  });
```

### IV. UI åŠŸèƒ½ä»‹ç»

--------

UI åŠŸèƒ½åŸºäº `electron-re` åŸºç¡€æ¶æ„å¼€å‘ï¼Œå®ƒé€šè¿‡å¼‚æ­¥ IPC å’Œä¸»è¿›ç¨‹çš„ `ProcessManager` è¿›è¡Œé€šä¿¡ï¼Œå®æ—¶åˆ·æ–°è¿›ç¨‹çŠ¶æ€ã€‚æ“ä½œè€…å¯ä»¥é€šè¿‡ UI æ‰‹åŠ¨ Kill è¿›ç¨‹ã€æŸ¥çœ‹è¿›ç¨‹ console æ•°æ®ã€æŸ¥çœ‹è¿›ç¨‹æ•° CPU/Memory å ç”¨è¶‹åŠ¿ä»¥åŠæŸ¥çœ‹ `MessageChannel` å·¥å…·çš„è¯·æ±‚å‘é€è®°å½•ã€‚

#### ä¸»ç•Œé¢

> UIå‚è€ƒ electron-process-manager è®¾è®¡

é¢„è§ˆå›¾ï¼š

![process-manager.main.png](http://nojsja.gitee.io/static-resources/images/electron-re/process-manager.main.png)

ä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š

1. å±•ç¤º Electron åº”ç”¨ä¸­æ‰€æœ‰å¼€å¯çš„è¿›ç¨‹ï¼ŒåŒ…æ‹¬ä¸»è¿›ç¨‹ã€æ™®é€šçš„æ¸²æŸ“è¿›ç¨‹ã€Service è¿›ç¨‹(electron-re å¼•å…¥)ã€ChildProcessPool åˆ›å»ºçš„å­è¿›ç¨‹(electron-re å¼•å…¥)ã€‚

2. è¿›ç¨‹åˆ—è¡¨ä¸­æ˜¾ç¤ºå„ä¸ªè¿›ç¨‹è¿›ç¨‹å·ã€è¿›ç¨‹æ ‡è¯†ã€çˆ¶è¿›ç¨‹å·ã€å†…å­˜å ç”¨å¤§å°ã€CPU å ç”¨ç™¾åˆ†æ¯”ç­‰ï¼Œæ‰€æœ‰è¿›ç¨‹æ ‡è¯†åˆ†ä¸ºï¼šmain(ä¸»è¿›ç¨‹)ã€service(æœåŠ¡è¿›ç¨‹)ã€renderer(æ¸²æŸ“è¿›ç¨‹)ã€node(è¿›ç¨‹æ± å­è¿›ç¨‹)ï¼Œç‚¹å‡»è¡¨æ ¼å¤´å¯ä»¥é’ˆå¯¹å¯¹æŸé¡¹è¿›è¡Œé€’å¢/é€’å‡æ’åºã€‚

3. é€‰ä¸­æŸä¸ªè¿›ç¨‹åå¯ä»¥ Kill æ­¤è¿›ç¨‹ã€æŸ¥çœ‹è¿›ç¨‹æ§åˆ¶å° Console æ•°æ®ã€æŸ¥çœ‹1åˆ†é’Ÿå†…è¿›ç¨‹ CPU/Memory å ç”¨è¶‹åŠ¿ï¼Œå¦‚æœæ­¤è¿›ç¨‹æ˜¯æ¸²æŸ“è¿›ç¨‹çš„è¯è¿˜å¯ä»¥é€šè¿‡ `DevTools` æŒ‰é’®ä¸€é”®æ‰“å¼€å†…ç½®è°ƒè¯•å·¥å…·ã€‚

4. ChildProcessPool åˆ›å»ºçš„å­è¿›ç¨‹æš‚ä¸æ”¯æŒç›´æ¥æ‰“å¼€ DevTools è¿›è¡Œè°ƒè¯•ï¼Œä¸è¿‡ç”±äºåˆ›å»ºå­è¿›ç¨‹æ—¶æ·»åŠ äº† `--inspect` å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ chrome çš„ `chrome://inspect` è¿›è¡Œè¿œç¨‹è°ƒè¯•ã€‚

5. ç‚¹å‡» `Signals` æŒ‰é’®å¯ä»¥æŸ¥çœ‹ `MessageChannel` å·¥å…·çš„è¯·æ±‚å‘é€æ—¥å¿—ï¼ŒåŒ…æ‹¬ç®€å•çš„è¯·æ±‚å‚æ•°ã€è¯·æ±‚åã€è¯·æ±‚è¿”å›æ•°æ®ç­‰ã€‚

#### åŠŸèƒ½ï¼šKill è¿›ç¨‹

![kill.gif](http://nojsja.gitee.io/static-resources/images/electron-re/kill.gif)

#### åŠŸèƒ½ï¼šä¸€é”®å¼€å¯ DevTools

![devtools.gif](http://nojsja.gitee.io/static-resources/images/electron-re/devtools.gif)

#### åŠŸèƒ½ï¼šæŸ¥çœ‹è¿›ç¨‹æ—¥å¿—

![console.gif](http://nojsja.gitee.io/static-resources/images/electron-re/console.gif)

#### åŠŸèƒ½ï¼šæŸ¥çœ‹è¿›ç¨‹ CPU/Memory å ç”¨è¶‹åŠ¿

![trends.gif](http://nojsja.gitee.io/static-resources/images/electron-re/trends.gif)

#### åŠŸèƒ½ï¼šæŸ¥çœ‹ MessageChannel è¯·æ±‚å‘é€æ—¥å¿—

![console.gif](http://nojsja.gitee.io/static-resources/images/electron-re/signals.png)

### V. æ–°ç‰¹æ€§ï¼šè¿›ç¨‹æ± è´Ÿè½½å‡è¡¡

-----------
> ç®€åŒ–çš„åˆç‰ˆå®ç°

[>> ä»£ç åœ°å€](https://github.com/nojsja/electron-re/blob/master/src/libs/LoadBalancer/algorithm/index.js)

#### â£ å…³äºè´Ÿè½½å‡è¡¡

â€œ è´Ÿè½½å‡è¡¡ï¼Œè‹±æ–‡åç§°ä¸º Load Balanceï¼Œå…¶å«ä¹‰å°±æ˜¯æŒ‡å°†è´Ÿè½½ï¼ˆå·¥ä½œä»»åŠ¡ï¼‰è¿›è¡Œå¹³è¡¡ã€åˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒä¸Šè¿›è¡Œè¿è¡Œï¼Œä¾‹å¦‚ FTP æœåŠ¡å™¨ã€WebæœåŠ¡å™¨ã€ä¼ä¸šæ ¸å¿ƒåº”ç”¨æœåŠ¡å™¨å’Œå…¶å®ƒä¸»è¦ä»»åŠ¡æœåŠ¡å™¨ç­‰ï¼Œä»è€ŒååŒå®Œæˆå·¥ä½œä»»åŠ¡ã€‚
è´Ÿè½½å‡è¡¡æ„å»ºåœ¨åŸæœ‰ç½‘ç»œç»“æ„ä¹‹ä¸Šï¼Œå®ƒæä¾›äº†ä¸€ç§é€æ˜ä¸”å»‰ä»·æœ‰æ•ˆçš„æ–¹æ³•æ‰©å±•æœåŠ¡å™¨å’Œç½‘ç»œè®¾å¤‡çš„å¸¦å®½ã€åŠ å¼ºç½‘ç»œæ•°æ®å¤„ç†èƒ½åŠ›ã€å¢åŠ ååé‡ã€æé«˜ç½‘ç»œçš„å¯ç”¨æ€§å’Œçµæ´»æ€§ã€‚â€ -- ã€Šç™¾åº¦ç™¾ç§‘ã€‹

#### â£ è´Ÿè½½å‡è¡¡ç­–ç•¥è¯´æ˜

ä¹‹å‰çš„å®ç°ä¸­ï¼Œè¿›ç¨‹æ± åˆ›å»ºå¥½åï¼Œå½“ä½¿ç”¨ pool å‘é€è¯·æ±‚æ—¶ï¼Œé‡‡ç”¨ä¸¤ç§æ–¹å¼å¤„ç†è¯·æ±‚å‘é€ç­–ç•¥ï¼š

1. é»˜è®¤ä½¿ç”¨è½®è¯¢ç­–ç•¥é€‰æ‹©ä¸€ä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚ï¼Œåªèƒ½ä¿è¯åŸºæœ¬çš„è¯·æ±‚å¹³å‡åˆ†é…ã€‚

2. å¦ä¸€ç§ä½¿ç”¨æƒ…å†µæ˜¯é€šè¿‡æ‰‹åŠ¨æŒ‡å®šå‘é€è¯·æ±‚æ—¶çš„é¢å¤–å‚æ•° idï¼š`pool.send(channel, params, id)`ï¼Œè¿™æ ·å­è®© `id` ç›¸åŒçš„è¯·æ±‚å‘é€åˆ°åŒä¸€ä¸ªå­è¿›ç¨‹ä¸Šã€‚ä¸€ä¸ªé€‚ç”¨æƒ…æ™¯å°±æ˜¯ï¼šç¬¬ä¸€æ¬¡æˆ‘ä»¬å‘æŸä¸ªå­è¿›ç¨‹å‘é€è¯·æ±‚ï¼Œè¯¥å­è¿›ç¨‹å¤„ç†è¯·æ±‚ååœ¨å…¶è¿è¡Œæ—¶å†…å­˜ç©ºé—´ä¸­å­˜å‚¨äº†ä¸€äº›å¤„ç†ç»“æœï¼Œä¹‹åæŸä¸ªæƒ…å†µä¸‹éœ€è¦å°†ä¹‹å‰é‚£æ¬¡è¯·æ±‚äº§ç”Ÿçš„å¤„ç†ç»“æœå†æ¬¡æ‹¿å›ä¸»è¿›ç¨‹ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ `id` æ¥åŒºåˆ†è¯·æ±‚ã€‚

æ–°ç‰ˆæœ¬å¼•å…¥äº†ä¸€äº›è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼š

- __POLLING__ - è½®è¯¢ï¼šå­è¿›ç¨‹è½®æµå¤„ç†è¯·æ±‚
- __WEIGHTS__ - æƒé‡ï¼šå­è¿›ç¨‹æ ¹æ®è®¾ç½®çš„æƒé‡æ¥å¤„ç†è¯·æ±‚
- __RANDOM__ - éšæœºï¼šå­è¿›ç¨‹éšæœºå¤„ç†è¯·æ±‚
- __SPECIFY__ - æŒ‡å®šï¼šå­è¿›ç¨‹æ ¹æ®æŒ‡å®šçš„è¿›ç¨‹ id å¤„ç†è¯·æ±‚
- __WEIGHTS_POLLING__ - æƒé‡è½®è¯¢ï¼šæƒé‡è½®è¯¢ç­–ç•¥ä¸è½®è¯¢ç­–ç•¥ç±»ä¼¼ï¼Œä½†æ˜¯æƒé‡è½®è¯¢ç­–ç•¥ä¼šæ ¹æ®æƒé‡æ¥è®¡ç®—å­è¿›ç¨‹çš„è½®è¯¢æ¬¡æ•°ï¼Œä»è€Œç¨³å®šæ¯ä¸ªå­è¿›ç¨‹çš„å¹³å‡å¤„ç†è¯·æ±‚æ•°é‡ã€‚
- __WEIGHTS_RANDOM__ - æƒé‡éšæœºï¼šæƒé‡éšæœºç­–ç•¥ä¸éšæœºç­–ç•¥ç±»ä¼¼ï¼Œä½†æ˜¯æƒé‡éšæœºç­–ç•¥ä¼šæ ¹æ®æƒé‡æ¥è®¡ç®—å­è¿›ç¨‹çš„éšæœºæ¬¡æ•°ï¼Œä»è€Œç¨³å®šæ¯ä¸ªå­è¿›ç¨‹çš„å¹³å‡å¤„ç†è¯·æ±‚æ•°é‡ã€‚
- __MINIMUM_CONNECTION__ - æœ€å°è¿æ¥æ•°ï¼šé€‰æ‹©å­è¿›ç¨‹ä¸Šå…·æœ‰æœ€å°è¿æ¥æ´»åŠ¨æ•°é‡çš„å­è¿›ç¨‹å¤„ç†è¯·æ±‚ã€‚
- __WEIGHTS_MINIMUM_CONNECTION__ - æƒé‡æœ€å°è¿æ¥æ•°ï¼šæƒé‡æœ€å°è¿æ¥æ•°ç­–ç•¥ä¸æœ€å°è¿æ¥æ•°ç­–ç•¥ç±»ä¼¼ï¼Œä¸è¿‡å„ä¸ªå­è¿›ç¨‹è¢«é€‰ä¸­çš„æ¦‚ç‡ç”±è¿æ¥æ•°å’Œæƒé‡å…±åŒå†³å®šã€‚

#### â£ è´Ÿè½½å‡è¡¡ç­–ç•¥çš„ç®€æ˜“å®ç°

å‚æ•°è¯´æ˜ï¼š

- tasksï¼šä»»åŠ¡æ•°ç»„ï¼Œä¸€ä¸ªç¤ºä¾‹ï¼š`[{id: 11101, weight: 2}, {id: 11102, weight: 1}]`ã€‚
- currentIndex: ç›®å‰æ‰€å¤„çš„ä»»åŠ¡ç´¢å¼•ï¼Œé»˜è®¤ä¸º 0ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨åŠ  1ï¼Œè¶…å‡ºä»»åŠ¡æ•°ç»„é•¿åº¦æ—¶ä¼šè‡ªåŠ¨å–æ¨¡ã€‚
- contextï¼šä¸»è¿›ç¨‹å‚æ•°ä¸Šä¸‹æ–‡ï¼Œç”¨äºåŠ¨æ€æ›´æ–°å½“å‰ä»»åŠ¡ç´¢å¼•å’Œæƒé‡ç´¢å¼•ã€‚
- weightIndexï¼šæƒé‡ç´¢å¼•ï¼Œç”¨äºæƒé‡ç­–ç•¥ï¼Œé»˜è®¤ä¸º 0ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨åŠ  1ï¼Œè¶…å‡ºæƒé‡æ€»å’Œæ—¶ä¼šè‡ªåŠ¨å–æ¨¡ã€‚
- weightTotalï¼šæƒé‡æ€»å’Œï¼Œç”¨äºæƒé‡ç­–ç•¥ç›¸å…³è®¡ç®—ã€‚
- connectionsMapï¼šå„ä¸ªè¿›ç¨‹æ´»åŠ¨è¿æ¥æ•°çš„æ˜ å°„ï¼Œç”¨äºæœ€å°è¿æ¥æ•°ç­–ç•¥ç›¸å…³è®¡ç®—ã€‚

##### 1. è½®è¯¢ç­–ç•¥(POLLING) 

> åŸç†ï¼šç´¢å¼•å€¼é€’å¢ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨åŠ  1ï¼Œè¶…å‡ºä»»åŠ¡æ•°ç»„é•¿åº¦æ—¶ä¼šè‡ªåŠ¨å–æ¨¡ï¼Œä¿è¯å¹³å‡è°ƒç”¨ã€‚
> æ—¶é—´å¤æ‚åº¦ O(n) = 1

```javascript
/* polling algorithm */
module.exports = function (tasks, currentIndex, context) {
  if (!tasks.length) return null;

  const task = tasks[currentIndex];
  context.currentIndex ++;
  context.currentIndex %= tasks.length;

  return task || null;
};
```

##### 2. æƒé‡ç­–ç•¥(WEIGHTS)

> åŸç†ï¼šæ¯ä¸ªè¿›ç¨‹æ ¹æ® (æƒé‡å€¼ + (æƒé‡æ€»å’Œ * éšæœºå› å­)) ç”Ÿæˆæœ€ç»ˆè®¡ç®—å€¼ï¼Œæœ€ç»ˆè®¡ç®—å€¼ä¸­çš„æœ€å¤§å€¼è¢«å‘½ä¸­ã€‚
> æ—¶é—´å¤æ‚åº¦ O(n) = n

```javascript
/* weight algorithm */
module.exports = function (tasks, weightTotal, context) {

  if (!tasks.length) return null;

  let max = tasks[0].weight, maxIndex = 0, sum;

  for (let i = 0; i < tasks.length; i++) {
    sum = (tasks[i].weight || 0) + Math.random() * weightTotal;
    if (sum >= max) {
      max = sum;
      maxIndex = i;
    }
  }

  context.weightIndex += 1;
  context.weightIndex %= (weightTotal + 1);

  return tasks[maxIndex];
};
```

##### 3. éšæœºç­–ç•¥(RANDOM)

> åŸç†ï¼šéšæœºå‡½æ•°åœ¨ [0, length) ä¸­ä»»æ„é€‰å–ä¸€ä¸ªç´¢å¼•å³å¯
> æ—¶é—´å¤æ‚åº¦ O(n) = 1

```javascript
/* random algorithm */
module.exports = function (tasks) {

  const length = tasks.length;
  const target = tasks[Math.floor(Math.random() * length)];

  return target || null;
};
```

##### 4. æƒé‡è½®è¯¢ç­–ç•¥(WEIGHTS_POLLING)

> åŸç†ï¼šç±»ä¼¼è½®è¯¢ç­–ç•¥ï¼Œä¸è¿‡è½®è¯¢çš„åŒºé—´ä¸ºï¼š[æœ€å°æƒé‡å€¼, æƒé‡æ€»å’Œ]ï¼Œæ ¹æ®å„é¡¹æƒé‡ç´¯åŠ å€¼è¿›è¡Œå‘½ä¸­åŒºé—´è®¡ç®—ã€‚æ¯æ¬¡è°ƒç”¨æ—¶æƒé‡ç´¢å¼•ä¼šè‡ªåŠ¨åŠ  1ï¼Œè¶…å‡ºæƒé‡æ€»å’Œæ—¶ä¼šè‡ªåŠ¨å–æ¨¡ã€‚
> æ—¶é—´å¤æ‚åº¦ O(n) = n

```javascript
/* weights polling */
module.exports = function (tasks, weightIndex, weightTotal, context) {

  if (!tasks.length) return null;

  let weight = 0;
  let task;

  for (let i = 0; i < tasks.length; i++) {
    weight += tasks[i].weight || 0;
    if (weight >= weightIndex) {
      task = tasks[i];
      break;
    }
  }

  context.weightIndex += 1;
  context.weightIndex %= (weightTotal + 1);

  return task;
};
```

##### 5. æƒé‡éšæœºç­–ç•¥(WEIGHTS_RANDOM)

> åŸç†ï¼šç”± (æƒé‡æ€»å’Œ * éšæœºå› å­) äº§ç”Ÿè®¡ç®—å€¼ï¼Œå°†å„é¡¹æƒé‡å€¼ä¸å…¶ç›¸å‡ï¼Œç¬¬ä¸€ä¸ªä¸å¤§äºé›¶çš„æœ€ç»ˆå€¼å³è¢«å‘½ä¸­ã€‚
> æ—¶é—´å¤æ‚åº¦ O(n) = n

```javascript
/* weights random algorithm */
module.exports = function (tasks, weightTotal) {
  let task;
  let weight = Math.ceil(Math.random() * weightTotal);

  for (let i = 0; i < tasks.length; i++) {
    weight -= tasks[i].weight || 0;
    if (weight <= 0) {
      task = tasks[i];
      break;
    }
  }

  return task || null;
};
```

##### 6. æœ€å°è¿æ¥æ•°ç­–ç•¥(MINIMUM_CONNECTION)

> åŸç†ï¼šç›´æ¥é€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°çš„é¡¹å³å¯ã€‚
> æ—¶é—´å¤æ‚åº¦ O(n) = n

```javascript
/* minimum connections algorithm */
module.exports = function (tasks, connectionsMap={}) {
  if (tasks.length < 2) return tasks[0] || null;

  let min = connectionsMap[tasks[0].id];
  let minIndex = 0;

  for (let i = 1; i < tasks.length; i++) {
    const con = connectionsMap[tasks[i].id] || 0;
    if (con <= min) {
      min = con;
      minIndex = i;
    }
  }

  return tasks[minIndex] || null;
};
```

##### 7. æƒé‡æœ€å°è¿æ¥æ•°(WEIGHTS_MINIMUM_CONNECTION)

> åŸç†ï¼šæƒé‡ + ( éšæœºå› å­ * æƒé‡æ€»å’Œ ) + ( è¿æ¥æ•°å æ¯” * æƒé‡æ€»å’Œ ) ä¸‰ä¸ªå› å­ï¼Œè®¡ç®—å‡ºæœ€ç»ˆå€¼ï¼Œæ ¹æ®æœ€ç»ˆå€¼çš„å¤§å°è¿›è¡Œæ¯”è¾ƒï¼Œæœ€å°å€¼æ‰€ä»£è¡¨é¡¹å³è¢«å‘½ä¸­ã€‚
> æ—¶é—´å¤æ‚åº¦ O(n) = n

```javascript
/* weights minimum connections algorithm */
module.exports = function (tasks, weightTotal, connectionsMap, context) {

  if (!tasks.length) return null;

  let min = tasks[0].weight, minIndex = 0, sum;

  const connectionsTotal = tasks.reduce((total, cur) => {
    total += (connectionsMap[cur.id] || 0);
    return total;
  }, 0);

  // algorithm: (weight + connections'weight) + random factor
  for (let i = 0; i < tasks.length; i++) {
    sum =
      (tasks[i].weight || 0) + (Math.random() * weightTotal) +
      (( (connectionsMap[tasks[i].id] || 0) * weightTotal ) / connectionsTotal);
    if (sum <= min) {
      min = sum;
      minIndex = i;
    }
  }

  context.weightIndex += 1;
  context.weightIndex %= (weightTotal + 1);

  return tasks[minIndex];
};
```

#### â£ è´Ÿè½½å‡è¡¡å™¨çš„å®ç°

ä»£ç éƒ½ä¸å¤æ‚ï¼Œæœ‰å‡ ç‚¹éœ€è¦è¯´æ˜ï¼š

1. __params__ å¯¹è±¡ä¿å­˜äº†ç”¨äºå„ç§ç­–ç•¥è®¡ç®—çš„ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚æƒé‡ç´¢å¼•ã€æƒé‡æ€»å’Œã€è¿æ¥æ•°ã€CPU/Memoryå ç”¨ç­‰ç­‰ã€‚
2. __scheduler__ å¯¹è±¡ç”¨äºè°ƒç”¨å„ç§ç­–ç•¥è¿›è¡Œè®¡ç®—ï¼Œ`scheduler.calculate()` ä¼šè¿”å›ä¸€ä¸ªå‘½ä¸­çš„è¿›ç¨‹ idã€‚
3. __targets__ å³æ‰€æœ‰ç”¨äºè®¡ç®—çš„ç›®æ ‡è¿›ç¨‹ï¼Œä¸è¿‡å…¶ä¸­ä»…å­˜æ”¾äº†ç›®æ ‡è¿›ç¨‹ pid å’Œ å…¶æƒé‡ weightï¼š`[{id: [pid], weight: [number]}, ...]`ã€‚
4. __algorithm__ ä¸ºç‰¹å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé»˜è®¤å€¼ä¸ºè½®è¯¢ç­–ç•¥ã€‚
5. __ProcessManager.on('refresh', this.refreshParams)__ï¼Œè´Ÿè½½å‡è¡¡å™¨é€šè¿‡ç›‘å¬ `ProcessManager` çš„ refresh äº‹ä»¶æ¥å®šæ—¶æ›´æ–°å„ä¸ªè¿›ç¨‹çš„è®¡ç®—å‚æ•°ã€‚`ProcessManager` ä¸­æœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šé‡‡é›†ä¸€æ¬¡å„ä¸ªè¢«ç›‘å¬çš„è¿›ç¨‹çš„èµ„æºå ç”¨æƒ…å†µï¼Œå¹¶æºå¸¦é‡‡é›†æ•°æ®è§¦å‘ä¸€æ¬¡ refresh äº‹ä»¶ã€‚


```javascript
const CONSTS = require("./consts");
const Scheduler = require("./scheduler");
const {
  RANDOM,
  POLLING,
  WEIGHTS,
  SPECIFY,
  WEIGHTS_RANDOM,
  WEIGHTS_POLLING,
  MINIMUM_CONNECTION,
  WEIGHTS_MINIMUM_CONNECTION,
} = CONSTS;
const ProcessManager = require('../ProcessManager');

/* Load Balance Instance */
class LoadBalancer {
  /**
    * @param  {Object} options [ options object ]
    * @param  {Array } options.targets [ targets for load balancing calculation: [{id: 1, weight: 1}, {id: 2, weight: 2}] ]
    * @param  {String} options.algorithm [ strategies for load balancing calculation : RANDOM | POLLING | WEIGHTS | SPECIFY | WEIGHTS_RANDOM | WEIGHTS_POLLING | MINIMUM_CONNECTION | WEIGHTS_MINIMUM_CONNECTION]
    */
  constructor(options) {
    this.targets = options.targets;
    this.algorithm = options.algorithm || POLLING;
    this.params = { // data for algorithm
      currentIndex: 0, // index
      weightIndex: 0, // index for weight alogrithm
      weightTotal: 0, // total weight
      connectionsMap: {}, // connections of each target
      cpuOccupancyMap: {}, // cpu occupancy of each target
      memoryOccupancyMap: {}, // cpu occupancy of each target
    };
    this.scheduler = new Scheduler(this.algorithm);
    this.memoParams = this.memorizedParams();
    this.calculateWeightIndex();
    ProcessManager.on('refresh', this.refreshParams);
  }

  /* params formatter */
  memorizedParams = () => {
    return {
      [RANDOM]: () => [],
      [POLLING]: () => [this.params.currentIndex, this.params],
      [WEIGHTS]: () => [this.params.weightTotal, this.params],
      [SPECIFY]: (id) => [id],
      [WEIGHTS_RANDOM]: () => [this.params.weightTotal],
      [WEIGHTS_POLLING]: () => [this.params.weightIndex, this.params.weightTotal, this.params],
      [MINIMUM_CONNECTION]: () => [this.params.connectionsMap],
      [WEIGHTS_MINIMUM_CONNECTION]: () => [this.params.weightTotal, this.params.connectionsMap, this.params],
    };
  }

  /* refresh params data */
  refreshParams = (pidMap) => { ... }

  /* pick one task from queue */
  pickOne = (...params) => {
    return this.scheduler.calculate(
      this.targets, this.memoParams[this.algorithm](...params)
    );
  }

  /* pick multi task from queue */
  pickMulti = (count = 1, ...params) => {
    return new Array(count).fill().map(
      () => this.pickOne(...params)
    );
  }

  /* calculate weight */
  calculateWeightIndex = () => {
    this.params.weightTotal = this.targets.reduce((total, cur) => total + (cur.weight || 0), 0);
    if (this.params.weightIndex > this.params.weightTotal) {
      this.params.weightIndex = this.params.weightTotal;
    }
  }

  /* calculate index */
  calculateIndex = () => {
    if (this.params.currentIndex >= this.targets.length) {
      this.params.currentIndex = (ths.params.currentIndex - 1 >= 0) ? (this.params.currentIndex - 1) : 0;
    }
  }

  /* clean data of a task or all task */
  clean = (id) => { ... }

  /* add a task */
  add = (task) => {...}

  /* remove target from queue */
  del = (target) => {...}

  /* wipe queue and data */
  wipe = () => {...}

  /* update calculate params */
  updateParams = (object) => {
    Object.entries(object).map(([key, value]) => {
      if (key in this.params) {
        this.params[key] = value;
      }
    });
  }

  /* reset targets */
  setTargets = (targets) => {...}

  /* change algorithm strategy */
  setAlgorithm = (algorithm) => {...}
}

module.exports = Object.assign(LoadBalancer, { ALGORITHM: CONSTS });
```

#### â£ è¿›ç¨‹æ± é…åˆ LoadBalancer æ¥å®ç°è´Ÿè½½å‡è¡¡

æœ‰å‡ ç‚¹éœ€è¦è¯´æ˜ï¼š

1. å½“æˆ‘ä»¬ä½¿ç”¨ `pool.send('channel', params)` æ—¶ï¼Œpool å†…éƒ¨ `getForkedFromPool()` å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå‡½æ•°ä»è¿›ç¨‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœå­è¿›ç¨‹æ•°æœªè¾¾åˆ°æœ€å¤§è®¾å®šæ•°ï¼Œåˆ™ä¼˜å…ˆåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚
2. å­è¿›ç¨‹ åˆ›å»º/é”€æ¯/é€€å‡º æ—¶éœ€è¦åŒæ­¥æ›´æ–° `LoadBalancer` ä¸­ç›‘å¬çš„ `targets`ï¼Œå¦åˆ™å·²è¢«é”€æ¯çš„è¿›ç¨‹ pid å¯èƒ½ä¼šåœ¨æ‰§è¡Œè´Ÿè½½å‡è¡¡ç­–ç•¥è®¡ç®—åè¢«è¿”å›ã€‚
3. `ForkedProcess` æ˜¯ä¸€ä¸ªè£…é¥°å™¨ç±»ï¼Œå°è£…äº† `child_process.fork` é€»è¾‘ï¼Œä¸ºå…¶å¢åŠ äº†ä¸€äº›é¢å¤–åŠŸèƒ½ï¼Œå¦‚ï¼šè¿›ç¨‹ç¡çœ ã€å”¤é†’ã€ç»‘å®šäº‹ä»¶ã€å‘é€è¯·æ±‚ç­‰åŸºæœ¬æ–¹æ³•ã€‚

```javascript
const _path = require('path');
const EventEmitter = require('events');

const ForkedProcess = require('./ForkedProcess');
const ProcessLifeCycle = require('../ProcessLifeCycle.class');
const ProcessManager = require('../ProcessManager/index');
const { defaultLifecycle } = require('../ProcessLifeCycle.class');
const LoadBalancer = require('../LoadBalancer');
let { inspectStartIndex } = require('../../conf/global.json');
const { getRandomString, removeForkedFromPool, convertForkedToMap, isValidValue } = require('../utils');
const { UPDATE_CONNECTIONS_SIGNAL } = require('../consts');

const defaultStrategy = LoadBalancer.ALGORITHM.POLLING;

class ChildProcessPool extends EventEmitter {
  constructor({
    path, max=6, cwd, env={},
    weights=[], // weights of processes, the length is equal to max
    strategy=defaultStrategy,
    ...
  }) {
    super();
    this.cwd = cwd || _path.dirname(path);
    this.env = {
      ...process.env,
      ...env
    };
    this.callbacks = {};
    this.pidMap = new Map();
    this.callbacksMap = new Map();
    this.connectionsMap={};
    this.forked = [];
    this.connectionsTimer = null;
    this.forkedMap = {};
    this.forkedPath = path;
    this.forkIndex = 0;
    this.maxInstance = max;
    this.weights = new Array(max).fill().map(
      (_, i) => (isValidValue(weights[i]) ? weights[i] : 1)
    );
    this.LB = new LoadBalancer({
      algorithm: strategy,
      targets: [],
    });

    this.initEvents();
  }

  /* -------------- internal -------------- */

  /* init events */
  initEvents = () => {
    // process exit
    this.on('forked_exit', (pid) => {
      this.onForkedDisconnect(pid);
    });
    ...
  }

  /**
    * onForkedCreate [triggered when a process instance created]
    * @param  {[String]} pid [process pid]
    */
  onForkedCreate = (forked) => {
    const pidsValue = this.forked.map(f => f.pid);
    const length = this.forked.length;

    this.LB.add({
      id: forked.pid,
      weight: this.weights[length - 1],
    });
    ProcessManager.listen(pidsValue, 'node', this.forkedPath);
    ...
  }

  /**
    * onForkedDisconnect [triggered when a process instance disconnect]
    * @param  {[String]} pid [process pid]
    */
   onForkedDisconnect = (pid) => {
    const length = this.forked.length;

    removeForkedFromPool(this.forked, pid, this.pidMap);
    this.LB.del({
      id: pid,
      weight: this.weights[length - 1],
    });
    ProcessManager.unlisten([pid]);
    ...
  }

  /* Get a process instance from the pool */
  getForkedFromPool = (id="default") => {
    let forked;
    if (!this.pidMap.get(id)) {
      // create new process and put it into the pool
      if (this.forked.length < this.maxInstance) {
        inspectStartIndex ++;
        forked = new ForkedProcess(
          this,
          this.forkedPath,
          this.env.NODE_ENV === "development" ? [`--inspect=${inspectStartIndex}`] : [],
          { cwd: this.cwd, env: { ...this.env, id }, stdio: 'pipe' }
        );
        this.forked.push(forked);
        this.onForkedCreate(forked);
      } else {
      // get a process from the pool based on load balancing strategy
        forked = this.forkedMap[this.LB.pickOne().id];
      }
      if (id !== 'default') {
        this.pidMap.set(id, forked.pid);
      }
    } else {
      // pick a special process from the pool
      forked = this.forkedMap[this.pidMap.get(id)];
    }

    if (!forked) throw new Error(`Get forked process from pool failed! the process pid: ${this.pidMap.get(id)}.`);

    return forked;
  }

  /* -------------- caller -------------- */

  /**
  * send [Send request to a process]
  * @param  {[String]} taskName [task name - necessary]
  * @param  {[Any]} params [data passed to process - necessary]
  * @param  {[String]} id [the unique id bound to a process instance - not necessary]
  * @return {[Promise]} [return a Promise instance]
  */
  send = (taskName, params, givenId) => {
    if (givenId === 'default') throw new Error('ChildProcessPool: Prohibit the use of this id value: [default] !')

    const id = getRandomString();
    const forked = this.getForkedFromPool(givenId);
    this.lifecycle.refresh([forked.pid]);

    return new Promise(resolve => {
      this.callbacks[id] = resolve;
      forked.send({action: taskName, params, id });
    });
  }
  ...
}

module.exports = ChildProcessPool;
```

### VI. æ–°ç‰¹æ€§ï¼šå­è¿›ç¨‹æ™ºèƒ½å¯åœ

-----------

è¿™ä¸ªç‰¹æ€§æˆ‘ä¹Ÿå°†å…¶ç§°ä¸º `è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ` (lifecycle)ã€‚

ä¸»è¦ä½œç”¨æ˜¯ï¼šå½“å­è¿›ç¨‹ä¸€æ®µæ—¶é—´æœªè¢«è°ƒç”¨ï¼Œåˆ™è‡ªåŠ¨è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå‡å°‘ CPU å ç”¨ (å‡å°‘å†…å­˜å ç”¨å¾ˆéš¾)ã€‚è¿›å…¥ä¼‘çœ çŠ¶æ€çš„æ—¶é—´å¯ä»¥å’Œç”±åˆ›å»ºè€…æ§åˆ¶ï¼Œé»˜è®¤ä¸º 10 minã€‚å½“å­è¿›ç¨‹è¿›å…¥ä¼‘çœ åï¼Œå¦‚æœæœ‰æ–°çš„è¯·æ±‚åˆ°æ¥å¹¶åˆ†å‘åˆ°è¯¥ä¼‘çœ çš„è¿›ç¨‹ä¸Šï¼Œåˆ™ä¼šè‡ªåŠ¨å”¤é†’è¯¥è¿›ç¨‹å¹¶ç»§ç»­å¤„ç†å½“å‰è¯·æ±‚ã€‚ä¸€æ®µæ—¶é—´é—²ç½®åï¼Œå°†ä¼šå†æ¬¡è¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚

#### â£ ä½¿è¿›ç¨‹ä¼‘çœ çš„å„ç§æ–¹å¼

1ï¼‰å¦‚æœæ˜¯è®©è¿›ç¨‹æš‚åœçš„è¯ï¼Œå¯ä»¥å‘è¿›ç¨‹å‘é€ `SIGSTOP` ä¿¡å·ï¼Œå‘é€ `SIGCONT` ä¿¡å·å¯ä»¥æ¢å¤è¿›ç¨‹ã€‚

Node.js:
```js
process.kill([pid], "SIGSTOP");
process.kill([pid], "SIGCONT");
```

Unix System (Windows æš‚æœªæµ‹è¯•):
```bash
kill -STOP [pid]
kill -CONT [pid]
```

2ï¼‰Node.js æ–°çš„ [Atomic.wait](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/wait) API ä¹Ÿå¯ä»¥åšåˆ°ç¼–ç¨‹æ§åˆ¶ã€‚è¯¥æ–¹æ³•ä¼šç›‘å¬ä¸€ä¸ª Int32Array å¯¹è±¡çš„ç»™å®šä¸‹æ ‡ä¸‹çš„å€¼ï¼Œè‹¥å€¼æœªå‘ç”Ÿæ”¹å˜ï¼Œåˆ™ä¸€ç›´ç­‰å¾…(é˜»å¡ event loop)ï¼Œç›´åˆ°å‘ç”Ÿè¶…æ—¶(ç”± ms å‚æ•°å†³å®š)ã€‚å¯ä»¥åœ¨ä¸»è¿›ç¨‹ä¸­æ“ä½œè¿™å—å…±äº«æ•°æ®ï¼Œç„¶åä¸ºå­è¿›ç¨‹è§£é™¤ä¼‘çœ é”å®šã€‚

```js
const nil = new Int32Array(new SharedArrayBuffer(4));
const array = new Array(100000).fill(0);
setInterval(() => {
console.log(1);
}, 1e3);
Atomics.wait(nil, 0, 0, Number(600e3));
```

#### â£ ç”Ÿå‘½å‘¨æœŸ LifeCycle çš„å®ç°

ä»£ç åŒæ ·å¾ˆç®€å•ï¼Œæœ‰å‡ ç‚¹éœ€è¦è¯´æ˜ï¼š

1. é‡‡ç”¨äº† `æ ‡è®°æ¸…é™¤æ³•`ï¼Œå­è¿›ç¨‹è§¦å‘è¯·æ±‚æ—¶æ›´æ–°è°ƒç”¨æ—¶é—´ï¼ŒåŒæ—¶ä½¿ç”¨å®šæ—¶å™¨å¾ªç¯è®¡ç®—å„ä¸ªè¢«ç›‘å¬å­è¿›ç¨‹çš„ ( å½“å‰æ—¶é—´ - ä¸Šæ¬¡è°ƒç”¨æ—¶é—´) å·®å€¼ã€‚å¦‚æœæœ‰è¶…è¿‡è®¾å®šçš„æ—¶é—´çš„è¿›ç¨‹åˆ™å‘é€ `sleep` ä¿¡å·ï¼ŒåŒæ—¶æºå¸¦æ‰€æœ‰è¿›ç¨‹ pidã€‚

2. æ¯ä¸ª `ChildProcessPool` è¿›ç¨‹æ± å®ä¾‹éƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ª `ProcessLifeCycle` å®ä¾‹å¯¹è±¡ç”¨äºæ§åˆ¶å½“å‰è¿›ç¨‹æ± ä¸­çš„è¿›ç¨‹çš„ ä¼‘çœ /å”¤é†’ã€‚`ChildProcessPool` ä¼šç›‘å¬ `ProcessLifeCycle` å¯¹è±¡çš„ `sleep` äº‹ä»¶ï¼Œæ‹¿åˆ°éœ€è¦ sleep çš„è¿›ç¨‹ pid åè°ƒç”¨ `ForkedProcess` çš„ `sleep()` æ–¹æ³•ä½¿å…¶ç¡çœ ã€‚ä¸‹ä¸ªè¯·æ±‚åˆ†å‘åˆ°è¯¥è¿›ç¨‹æ—¶ï¼Œä¼šè‡ªåŠ¨å”¤é†’è¯¥è¿›ç¨‹ã€‚

```javascript
const EventEmitter = require('events');

const defaultLifecycle = {
  expect: 600e3, // default timeout 10 minutes
  internal: 30e3 // default loop check interval 30 seconds
};

class ProcessLifeCycle extends EventEmitter {
  constructor(options) {
    super();
    const {
      expect=defaultLifecycle.expect,
      internal=defaultLifecycle.internal
    } = options;
    this.timer = null;
    this.internal = internal;
    this.expect = expect;
    this.params = {
      activities: new Map()
    };
  }

  /* task check loop */
  taskLoop = () => {
    if (this.timer) return console.warn('ProcessLifeCycle: the task loop is already running');

    this.timer = setInterval(() => {
      const sleepTasks = [];
      const date = new Date();
      const { activities } = this.params;
      ([...activities.entries()]).map(([key, value]) => {
        if (date - value > this.expect) {
          sleepTasks.push(key);
        }
      });
      if (sleepTasks.length) {
        // this.unwatch(sleepTasks);
        this.emit('sleep', sleepTasks);
      }
    }, this.internal);
  }

  /* watch processes */
  watch = (ids=[]) => {
    ids.forEach(id => {
      this.params.activities.set(id, new Date());
    });
  }

  /* unwatch processes */
  unwatch = (ids=[]) => {
    ids.forEach(id => {
      this.params.activities.delete(id);
    });
  }

  /* stop task check loop */
  stop = () => {
    clearInterval(this.timer);
    this.timer = null;
  }

  /* start task check loop */
  start = () => {
    this.taskLoop();
  }

  /* refresh tasks */
  refresh = (ids=[]) => {
    ids.forEach(id => {
      if (this.params.activities.has(id)) {
        this.params.activities.set(id, new Date());
      } else {
        console.warn(`The task with id ${id} is not being watched.`);
      }
    });
  }
}

module.exports = Object.assign(ProcessLifeCycle, { defaultLifecycle });
```

#### â£ è¿›ç¨‹äº’æ–¥é”çš„é›å½¢

ä¹‹å‰çœ‹æ–‡ç« æ—¶çœ‹åˆ°å…³äº API - [Atomic.wait](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/wait) çš„ä¸€ç¯‡æ–‡ç« ï¼ŒAtomic é™¤äº†ç”¨äºå®ç°è¿›ç¨‹ç¡çœ ï¼Œä¹Ÿèƒ½åŸºäºå®ƒæ¥ç†è§£è¿›ç¨‹äº’æ–¥é”çš„å®ç°åŸç†ã€‚è¿™é‡Œæœ‰ä¸ª[åŸºæœ¬é›å½¢](https://github.com/nojsja/electron-re/blob/master/src/libs/AsyncLock.js)å¯ä»¥ä½œä¸ºå‚è€ƒï¼Œç›¸å…³æ–‡æ¡£å¯ä»¥å‚é˜… [MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Atomics)ã€‚

AsyncLock å¯¹è±¡éœ€è¦åœ¨å­è¿›ç¨‹ä¸­å¼•å…¥ï¼Œåˆ›å»º AsyncLock çš„æ„é€ å‡½æ•°ä¸­æœ‰ä¸€ä¸ªå‚æ•° `sab` éœ€è¦æ³¨æ„ã€‚è¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª `SharedArrayBuffer` å…±äº«æ•°æ®å—ï¼Œè¿™ä¸ªå…±äº«æ•°æ®å¿«éœ€è¦åœ¨ä¸»è¿›ç¨‹åˆ›å»ºï¼Œç„¶åé€šè¿‡ IPC é€šä¿¡å‘é€åˆ°å„ä¸ªå­è¿›ç¨‹ï¼Œé€šå¸¸ IPC é€šä¿¡ä¼šåºåˆ—åŒ–ä¸€èˆ¬çš„è¯¸å¦‚ Object / Array ç­‰æ•°æ®ï¼Œå¯¼è‡´æ¶ˆæ¯æ¥å—è€…å’Œæ¶ˆæ¯å‘é€è€…æ‹¿åˆ°çš„ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯ç»ç”± IPC å‘é€çš„ `SharedArrayBuffer` å¯¹è±¡å´ä¼šæŒ‡å‘åŒä¸€ä¸ªå†…å­˜å—ã€‚

åœ¨å­è¿›ç¨‹ä¸­ä½¿ç”¨ `SharedArrayBuffer` æ•°æ®åˆ›å»º AsyncLock å®ä¾‹åï¼Œä»»æ„ä¸€ä¸ªå­è¿›ç¨‹å¯¹å…±äº«æ•°æ®çš„ä¿®æ”¹éƒ½ä¼šå¯¼è‡´å…¶å®ƒè¿›ç¨‹å†…æŒ‡å‘è¿™å—å†…å­˜çš„ `SharedArrayBuffer` æ•°æ®å†…å®¹å˜åŒ–ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨å®ƒå®ç°è¿›ç¨‹é”çš„åŸºæœ¬è¦ç‚¹ã€‚

å…ˆå¯¹ `Atomic` API åšä¸ªç®€å•è¯´æ˜ï¼š

- __Atomics.compareExchange(typedArray, index, expectedValue, newValue)__ï¼šAtomics.compareExchange() é™æ€æ–¹æ³•ä¼šåœ¨æ•°ç»„çš„å€¼ä¸æœŸæœ›å€¼ç›¸ç­‰çš„æ—¶å€™ï¼Œå°†ç»™å®šçš„æ›¿æ¢å€¼æ›¿æ¢æ‰æ•°ç»„ä¸Šçš„å€¼ï¼Œç„¶åè¿”å›æ—§å€¼ã€‚æ­¤åŸå­æ“ä½œä¿è¯åœ¨å†™ä¸Šä¿®æ”¹çš„å€¼ä¹‹å‰ä¸ä¼šå‘ç”Ÿå…¶ä»–å†™æ“ä½œã€‚
- __Atomics.waitAsync(typedArray, index, value[, timeout])__ï¼šé™æ€æ–¹æ³• Atomics.wait() ç¡®ä¿äº†ä¸€ä¸ªåœ¨ Int32Array æ•°ç»„ä¸­ç»™å®šä½ç½®çš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ä¸”ä»ç„¶æ˜¯ç»™å®šçš„å€¼æ—¶è¿›ç¨‹å°†ä¼šç¡çœ ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è¶…æ—¶ã€‚è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå€¼ä¸º"ok", "not-equal", æˆ– "timed-out" ä¹‹ä¸€ã€‚
- __Atomics.notify(typedArray, index[, count])__ï¼šé™æ€æ–¹æ³• Atomics.notify() å”¤é†’æŒ‡å®šæ•°é‡çš„åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ä¼‘çœ çš„è¿›ç¨‹ï¼Œä¸æŒ‡å®š count æ—¶é»˜è®¤å”¤é†’æ‰€æœ‰ã€‚

AsyncLock å³å¼‚æ­¥é”ï¼Œç­‰å¾…é”é‡Šæ”¾çš„æ—¶å€™ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚ä¸»è¦å…³æ³¨ `executeAfterLocked()` è¿™ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å¹¶ä¼ å…¥å›è°ƒå‡½æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨é”è¢«è·å–åæ‰§è¡Œï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œå®Œæ¯•åè‡ªåŠ¨é‡Šæ”¾é”ã€‚å…¶ä¸­ä¸€æ­¥çš„å…³é”®å°±æ˜¯ `tryGetLock()` å‡½æ•°ï¼Œå®ƒè¿”å›äº†ä¸€ä¸ª `Promise` å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬ç­‰å¾…é”é‡Šæ”¾çš„é€»è¾‘åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œè€Œå¹¶ä¸é˜»å¡ä¸»çº¿ç¨‹ã€‚

```javascript
/**
  * @name AsyncLock
  * @description
  *   Use it in child processes, mutex lock logic.
  *   First create SharedArrayBuffer in main process and transfer it to all child processes to control the lock.
  */

class AsyncLock {
  static INDEX = 0;
  static UNLOCKED = 0;
  static LOCKED = 1;

  constructor(sab) {
    this.sab = sab; // data like this: const sab = new SharedArrayBuffer(16);
    this.i32a = new Int32Array(sab);
  }

  lock() {
    while (true) {
      const oldValue = Atomics.compareExchange(
        this.i32a, AsyncLock.INDEX,
        AsyncLock.UNLOCKED, // old
        AsyncLock.LOCKED // new
      );
      if (oldValue == AsyncLock.UNLOCKED) { // success
        return;
      }
      Atomics.wait( // wait
        this.i32a,
        AsyncLock.INDEX,
        AsyncLock.LOCKED // expect
      );
    }
  }

  unlock() {
    const oldValue = Atomics.compareExchange(
      this.i32a, AsyncLock.INDEX,
      AsyncLock.LOCKED,
      AsyncLock.UNLOCKED
    );
    if (oldValue != AsyncLock.LOCKED) { // failed
      throw new Error('Tried to unlock while not holding the mutex');
    }
    Atomics.notify(this.i32a, AsyncLock.INDEX, 1);
  }

  /**
    * executeLocked [async function to acquired the lock and execute callback]
    * @param  {Function} callback [callback function]
    */
  executeAfterLocked(callback) {

    const tryGetLock = async () => {
      while (true) {
        const oldValue = Atomics.compareExchange(
          this.i32a,
          AsyncLock.INDEX,
          AsyncLock.UNLOCKED,
          AsyncLock.LOCKED
        );
        if (oldValue == AsyncLock.UNLOCKED) { // success if AsyncLock.UNLOCKED
          callback();
          this.unlock();
          return;
        }
        const result = Atomics.waitAsync( // wait when AsyncLock.LOCKED
          this.i32a,
          AsyncLock.INDEX,
          AsyncLock.LOCKED
        );
        await result.value; // return a Promise, will not block the main thread
      }
    }

    tryGetLock();
  }
}
```



### VII. å­˜åœ¨çš„å·²çŸ¥é—®é¢˜

------------

1. ç”±äºä½¿ç”¨äº† Electron åŸç”Ÿçš„ `remote` APIï¼Œå› æ­¤ `electron-re` éƒ¨åˆ†ç‰¹æ€§(Service ç›¸å…³)ä¸æ”¯æŒ Electron 14 ä»¥åŠä»¥ä¸Šç‰ˆæœ¬(å·²ç»ç§»é™¤ remote)ï¼Œæ­£è€ƒè™‘è¿‘æœŸä½¿ç”¨ç¬¬ä¸‰æ–¹ `remote` åº“è¿›è¡Œæ›¿ä»£å…¼å®¹ã€‚

2. å®¹é”™å¤„ç†åšçš„ä¸å¤Ÿå¥½ï¼Œè¿™ä¸€å—ä¼šæˆä¸ºä¹‹åçš„é‡è¦ä¼˜åŒ–ç‚¹ã€‚

3. é‡‡é›†è¿›ç¨‹æ± ä¸­æ´»åŠ¨è¿æ¥æ•°æ—¶é‡‡ç”¨äº†"è°ƒç”¨è®¡æ•°"çš„æ–¹å¼ã€‚è¿™ä¸ªå¤„ç†æ–¹æ³•ä¸å¤ªå¥½ï¼Œå‡†ç¡®æ€§ä¹Ÿä¸å¤Ÿé«˜ï¼Œä½†æ˜¯ç›®å‰è¿˜æœªæƒ³åˆ°æ›´å¥½çš„è§£å†³æ–¹æ³•ç”¨äºç»Ÿè®¡å­è¿›ç¨‹ä¸­æ´»è·ƒçš„è¿æ¥æ•°ã€‚æˆ‘è§‰å¾—è¿˜æ˜¯è¦ä»åº•å±‚è¿›è¡Œè§£å†³ï¼Œæ¯”å¦‚ï¼šå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ã€V8 è™šæ‹Ÿæœºã€åƒåœ¾å›æ”¶ã€Libuv åº•å±‚åŸç†ã€Node è¿›ç¨‹å’Œçº¿ç¨‹åŸç†...

4. æš‚æ—¶æ²¡åœ¨ windows å¹³å°æµ‹è¯•è¿›ç¨‹ä¼‘çœ åŠŸèƒ½ï¼Œwin å¹³å°æœ¬èº«ä¸æ”¯æŒè¿›ç¨‹ä¿¡å·ï¼Œä½†æ˜¯ Node æä¾›äº†æ¨¡æ‹Ÿæ”¯æŒï¼Œä½†æ˜¯å…·ä½“è¡¨ç°è¿˜éœ€æµ‹è¯•ã€‚

### VIII. Next To Do

----------------------

- [x] è®© Service æ”¯æŒä»£ç æ›´æ–°åè‡ªåŠ¨é‡å¯
- [x] æ·»åŠ  ChildProcessPool å­è¿›ç¨‹è°ƒåº¦é€»è¾‘
- [x] ä¼˜åŒ– ChildProcessPool å¤šè¿›ç¨‹consoleè¾“å‡º
- [x] æ·»åŠ å¯è§†åŒ–è¿›ç¨‹ç®¡ç†ç•Œé¢
- [x] å¢å¼º ChildProcessPool è¿›ç¨‹æ± åŠŸèƒ½
- [ ] å¢å¼º ProcessHost äº‹åŠ¡ä¸­å¿ƒåŠŸèƒ½
- [ ] å­è¿›ç¨‹ä¹‹é—´äº’æ–¥é”é€»è¾‘çš„å®ç°
- [ ] ä½¿ç”¨å¤–éƒ¨ remote åº“ä»¥æ”¯æŒæœ€æ–°ç‰ˆæœ¬çš„ Electron
- [ ] __Kill Bugs__ ğŸ›

### IX. å‡ ä¸ªå®é™…ä½¿ç”¨ç¤ºä¾‹

----------------------

1. [electronux](https://github.com/nojsja/electronux) - æˆ‘çš„ä¸€ä¸ªElectroné¡¹ç›®ï¼Œä½¿ç”¨äº† `BrowserService/MessageChannel`ï¼Œå¹¶ä¸”é™„å¸¦äº†`ChildProcessPool/ProcessHost`ä½¿ç”¨demoã€‚


2. [shadowsocks-electron](https://github.com/nojsja/shadowsocks-electron) - æˆ‘çš„å¦ä¸€ä¸ªElectron è·¨å¹³å°æ¡Œé¢åº”ç”¨é¡¹ç›®ï¼Œä½¿ç”¨ `electron-re` è¿›è¡Œè°ƒè¯•å¼€å‘ï¼Œå¹¶ä¸”åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å¯ä»¥æ‰“å¼€ `ProcessManager` UI ç”¨äº CPU/Memory èµ„æºå ç”¨ç›‘æ§å’Œè¯·æ±‚æ—¥å¿—æŸ¥çœ‹ã€‚

3. [file-slice-upload](https://github.com/nojsja/javascript-learning/tree/master/file-slice-upload) - ä¸€ä¸ªå…³äºå¤šæ–‡ä»¶åˆ†ç‰‡å¹¶è¡Œä¸Šä¼ çš„demoï¼Œä½¿ç”¨äº† `ChildProcessPool` and `ProcessHost`ï¼ŒåŸºäº Electron@9.3.5å¼€å‘ã€‚

4. ä¹Ÿå¯ç›´æ¥æŸ¥çœ‹ `index.test.js` å’Œ `test` ç›®å½•ä¸‹çš„æµ‹è¯•æ ·ä¾‹æ–‡ä»¶ï¼ŒåŒ…å«äº†ä¸€äº›ä½¿ç”¨ç¤ºä¾‹ã€‚

5. å½“ç„¶ github - [README](https://github.com/nojsja/electron-re) ä¹Ÿæœ‰ç›¸å…³è¯´æ˜é¡¹ã€‚
